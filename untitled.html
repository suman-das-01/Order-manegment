<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Das Mobile â€” Order Demo (Netlify)</title>
<style>
  :root{--blue:#1976d2;--green:#28a745;--muted:#666}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f4f6fb;margin:0;padding:20px}
  .wrap{max-width:960px;margin:12px auto}
  header{display:flex;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:12px 16px;border-radius:8px}
  header h1{font-size:18px;margin:0}
  .card{background:#fff;border-radius:10px;padding:14px;margin-top:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  form .row{display:flex;gap:8px;margin-bottom:8px}
  input[type=text], textarea, select{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px}
  button{background:var(--blue);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
  button.warn{background:#e67a00}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .thumb{width:56px;height:56px;object-fit:cover;border-radius:6px;cursor:pointer}
  .status{padding:6px 8px;border-radius:6px;color:#fff;font-weight:600}
  .status.pending{background:#ffc107;color:#000}
  .status.collected{background:var(--green)}
  .status.notfound{background:#d32f2f}
  .actions button{margin-right:6px}
  .time{color:var(--muted);font-size:13px}
  .empty{color:var(--muted);padding:20px;text-align:center}
  /* modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{background:#fff;padding:12px;border-radius:8px;max-width:90%;max-height:90%;overflow:auto}
  img.full{max-width:90vw;max-height:80vh;display:block}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  @media(max-width:640px){ .row{flex-direction:column} .thumb{width:48px;height:48px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ“¦ Das Mobile â€” Orders (Demo)</h1>
      <div class="small">Local demo â€¢ No backend â€¢ Netlify friendly</div>
    </header>

    <div class="card" id="addCard">
      <h3>Add New Order</h3>
      <div class="small">Fill product & customer name. Image optional (local demo only).</div>
      <form id="orderForm" onsubmit="return false;">
        <div class="row">
          <input id="product" type="text" placeholder="Product (e.g. K20 lcd)" required>
          <input id="customer" type="text" placeholder="Customer name" required>
        </div>
        <div class="row">
          <input id="qty" type="text" placeholder="Qty (e.g. 1)">
          <input id="phone" type="text" placeholder="Phone (optional)">
        </div>
        <div class="row">
          <input id="file" type="file" accept="image/*">
          <button id="addBtn">Save Order</button>
        </div>
        <div class="row">
          <textarea id="note" placeholder="Description / Note" rows="2"></textarea>
        </div>
      </form>
      <div id="msg" class="small" style="margin-top:6px;color:green;display:none"></div>
    </div>

    <div class="card">
      <h3>Order List</h3>
      <div id="ordersWrap"></div>
    </div>

    <footer>Demo â€” data saved in your browser (localStorage). To use real DB use Supabase / Firebase.</footer>
  </div>

  <!-- image modal -->
  <div id="overlay" style="display:none" class="overlay" onclick="hideModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div style="text-align:right"><button onclick="hideModal()">Close</button></div>
      <img id="modalImg" class="full" src="">
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const LS_KEY = 'das_orders_v1';

function uid(){ return 'id'+Date.now() + Math.floor(Math.random()*999); }
function now(){ return new Date().toISOString(); }
function saveOrders(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function loadOrders(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]') }catch(e){return []} }
function timeAgo(iso){
  if(!iso) return '';
  const diff = Math.floor((Date.now() - new Date(iso).getTime())/1000);
  if(diff < 60) return diff + 's ago';
  if(diff < 3600) return Math.floor(diff/60) + 'm ago';
  if(diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

/* ---------- UI / Data ---------- */
let orders = loadOrders();
const ordersWrap = document.getElementById('ordersWrap');
const fileInput = document.getElementById('file');
const addBtn = document.getElementById('addBtn');
const msg = document.getElementById('msg');

function render(){
  if(!orders.length){
    ordersWrap.innerHTML = '<div class="empty">No orders yet â€” add one above.</div>';
    return;
  }
  let html = `<table><thead><tr><th>Image</th><th>Product</th><th>Customer</th><th>Status</th><th>Note</th><th>Time</th><th>Action</th></tr></thead><tbody>`;
  orders.slice().reverse().forEach(o => {
    const stClass = o.status === 'pending' ? 'pending' : (o.status === 'collected' ? 'collected' : 'notfound');
    const thumb = o.imageData ? `<img src="${o.imageData}" class="thumb" onclick="openImg('${o.id}')">` : `<div style="width:56px;height:56px;border-radius:6px;background:#f1f3f4;display:flex;align-items:center;justify-content:center;color:#888">No</div>`;
    html += `<tr>
      <td>${thumb}</td>
      <td>${escapeHtml(o.product)} ${o.qty?('<div class="small">Qty: '+escapeHtml(o.qty)+'</div>'):''}</td>
      <td>${escapeHtml(o.customer)} ${o.phone?('<div class="small">'+escapeHtml(o.phone)+'</div>'):''}</td>
      <td><span class="status ${stClass}">${o.status}</span> ${o.purchasePrice?('<div class="small">â‚¹'+o.purchasePrice+'</div>'):''}</td>
      <td>${escapeHtml(o.note||'')}</td>
      <td class="time">${timeAgo(o.createdAt)}</td>
      <td class="actions">
        <button onclick="markCollected('${o.id}')">Collect</button>
        <button onclick="markNotFound('${o.id}')" class="warn">Not Found</button>
        <button onclick="setPending('${o.id}')">Pending</button>
        <button onclick="editNote('${o.id}')">Edit</button>
        <button onclick="removeOrder('${o.id}')">Delete</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  ordersWrap.innerHTML = html;
}

/* escape to avoid HTML injection in demo */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Actions ---------- */
document.getElementById('orderForm').addEventListener('submit', async e=>{
  e.preventDefault();
  addBtn.disabled = true;
  addBtn.textContent = 'Saving...';
  const product = document.getElementById('product').value.trim();
  const customer = document.getElementById('customer').value.trim();
  const qty = document.getElementById('qty').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const note = document.getElementById('note').value.trim();
  let imageData = null;
  const f = fileInput.files && fileInput.files[0];
  if(f){
    imageData = await readFileAsDataURL(f);
  }
  const order = {
    id: uid(),
    product, customer, qty, phone, note,
    imageData, status: 'pending',
    createdAt: now(),
    purchasePrice: null,
    collectedBy: null
  };
  orders.push(order);
  saveOrders(orders);
  render();
  showMsg('Order saved');
  document.getElementById('orderForm').reset();
  addBtn.disabled = false;
  addBtn.textContent = 'Save Order';
});

function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onerror = ()=>rej('file error');
    r.onload = ()=>res(r.result);
    r.readAsDataURL(file);
  });
}

function showMsg(t){
  msg.style.display = 'block';
  msg.textContent = t;
  setTimeout(()=> msg.style.display='none',2500);
}

function findIndex(id){ return orders.findIndex(o=>o.id===id); }

function markCollected(id){
  const idx = findIndex(id); if(idx<0) return;
  const price = prompt('Enter purchase price (numbers only):'); 
  if(price === null) return; // cancelled
  if(price.trim()==='') return alert('Price required to mark collected.');
  if(!confirm('Are you sure you want to mark as COLLECTED?')) return;
  orders[idx].status = 'collected';
  orders[idx].purchasePrice = price.trim();
  orders[idx].collectedBy = prompt('Who collected? (name)') || '';
  saveOrders(orders); render(); showMsg('Marked collected');
}

function markNotFound(id){
  const idx = findIndex(id); if(idx<0) return;
  const reason = prompt('Enter reason (where not found):');
  if(reason === null) return;
  if(!confirm('Save as NOT FOUND?')) return;
  orders[idx].status = 'not_found';
  orders[idx].note = (orders[idx].note?orders[idx].note+' | ':'') + 'NOT FOUND: '+reason;
  saveOrders(orders); render(); showMsg('Marked not found');
}

function setPending(id){
  const idx = findIndex(id); if(idx<0) return;
  orders[idx].status = 'pending';
  saveOrders(orders); render(); showMsg('Status set pending');
}

function editNote(id){
  const idx = findIndex(id); if(idx<0) return;
  const newNote = prompt('Edit note:', orders[idx].note || '');
  if(newNote === null) return;
  orders[idx].note = newNote;
  saveOrders(orders); render(); showMsg('Note updated');
}

function removeOrder(id){
  if(!confirm('Delete this order?')) return;
  orders = orders.filter(o=>o.id!==id);
  saveOrders(orders); render(); showMsg('Order deleted');
}

/* image modal */
function openImg(id){
  const o = orders.find(x=>x.id===id);
  if(!o || !o.imageData) return;
  document.getElementById('modalImg').src = o.imageData;
  document.getElementById('overlay').style.display = 'flex';
}
function hideModal(){ document.getElementById('overlay').style.display='none'; }

/* update time stamps every 30s */
setInterval(()=>{ const times = document.querySelectorAll('.time'); times.forEach((el,i)=>{ try{ const row = orders.slice().reverse()[i]; if(row) el.textContent = timeAgo(row.createdAt); }catch(e){} }); },30000);

/* initial render */
render();
</script>
</body>
</html>